import os
import json
import requests
import tarfile
from io import BytesIO

image = "nginx"
tag = "latest"
registry = "registry-1.docker.io"
repo = f"library/{image}"
output_dir = f"{image}_{tag}_image"

os.makedirs(output_dir, exist_ok=True)

# 1. Lấy Token
token_url = f"https://auth.docker.io/token?service=registry.docker.io&scope=repository:{repo}:pull"
token = requests.get(token_url).json()["token"]

# 2. Lấy manifest
headers = {
    "Authorization": f"Bearer {token}",
    "Accept": "application/vnd.docker.distribution.manifest.v2+json"
}
manifest_url = f"https://{registry}/v2/{repo}/manifests/{tag}"
manifest = requests.get(manifest_url, headers=headers).json()

# 3. Tải config.json
config_digest = manifest["config"]["digest"]
config_url = f"https://{registry}/v2/{repo}/blobs/{config_digest}"
config_res = requests.get(config_url, headers={"Authorization": f"Bearer {token}"})
config_filename = config_digest.replace(":", "_") + ".json"
with open(os.path.join(output_dir, config_filename), "wb") as f:
    f.write(config_res.content)

# 4. Tải các layers
layer_filenames = []
for layer in manifest["layers"]:
    digest = layer["digest"]
    url = f"https://{registry}/v2/{repo}/blobs/{digest}"
    layer_filename = digest.replace(":", "_") + ".tar.gz"
    layer_filenames.append(layer_filename)

    print(f"Tải layer {digest} → {layer_filename}")
    r = requests.get(url, headers={"Authorization": f"Bearer {token}"}, stream=True)
    with open(os.path.join(output_dir, layer_filename), "wb") as f:
        for chunk in r.iter_content(8192):
            f.write(chunk)

# 5. Tạo manifest.json
manifest_json = [{
    "Config": config_filename,
    "RepoTags": [f"{image}:{tag}"],
    "Layers": layer_filenames
}]
with open(os.path.join(output_dir, "manifest.json"), "w") as f:
    json.dump(manifest_json, f)

# 6. Đóng gói thành file .tar
tar_filename = f"{image}_{tag}.tar"
with tarfile.open(tar_filename, "w") as tar:
    for filename in [config_filename] + layer_filenames + ["manifest.json"]:
        tar.add(os.path.join(output_dir, filename), arcname=filename)

print(f"Đã tạo file Docker image: {tar_filename}")
